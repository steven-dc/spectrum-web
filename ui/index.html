<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Volumio Spectrum Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Control Bar -->
    <div id="controlBar">
        <div id="fpsCounter" class="control-item">FPS: -- | Packets: 0</div>
        <div id="status" class="control-item connecting">‚óè Connecting</div>
        <div id="toggleSettings" class="control-item" onclick="toggleSettings()">‚öôÔ∏è</div>
    </div>

    <!-- Canvas Container -->
    <div id="canvasContainer">
        <div id="backgroundLayer"></div>
    </div>

    <!-- Now Playing -->
    <div id="nowPlaying" class="hidden">
        <div class="resize-handle resize-tl"></div>
        <div class="resize-handle resize-tr"></div>
        <div class="resize-handle resize-bl"></div>
        <div class="resize-handle resize-br"></div>
        <div class="player-container">
            <div class="track-art">
                <img id="trackArt" src="" alt="">
            </div>
            <div class="track-details">
                <div class="track-title" id="trackTitle">No track playing</div>
                <div class="track-artist" id="trackArtist">Unknown Artist</div>
                <div class="track-album" id="trackAlbum">Unknown Album</div>
                <div class="track-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
            </div>
            <div class="player-controls">
                <div class="control-btn" onclick="volumioPrevious()" title="Previous">‚Æú</div>
                <div class="control-btn play" id="playPauseBtn" onclick="volumioTogglePlay()" title="Play/Pause">‚ñ∂</div>
                <div class="control-btn" onclick="volumioNext()" title="Next">‚Æû</div>
                <div class="control-btn" onclick="toggleQueue()" title="Queue">‚ò∞</div>
                <div class="control-btn" onclick="openVolumioMusic()" title="Browse Music">üéµ</div>
            </div>
        </div>
    </div>

    <!-- Click Prompt -->
    <!-- <div id="clickPrompt" class="hidden">
        <h3>üéß Audio Ready</h3>
        <p>Click to start audio playback and visualization</p>
        <button id="startAudioBtn">Start Audio</button>
    </div> -->

    <div id="queuePanel">
        <div class="panel-header">
            <div class="panel-title">üéµ Play Queue</div>
            <div class="close-btn" onclick="toggleQueue()">√ó</div>
        </div>
        <div id="queueList"></div>
    </div>

    <div id="browsePanel">
        <div class="panel-header">
            <div class="panel-title" id="browseTitle">üé∂ Music Library</div>
            <div class="close-btn" onclick="toggleBrowse()">√ó</div>
        </div>
        <div id="browsePath" style="padding: 8px 12px; background: #1a1e25; font-size: 12px; color: #8b9dc3; border-bottom: 1px solid #2a2e35;"></div>
        <div id="browseList"></div>
    </div>
    <!-- Settings Panel -->
    <div id="settingsPanel">
        <div class="panel-header">
            <div class="panel-title">‚öôÔ∏è Settings</div>
            <div class="close-btn" onclick="toggleSettings()">√ó</div>
        </div>

        <div class="settings-tabs">
            <button class="tab-btn active" onclick="switchTab('basic')">Basic</button>
            <button class="tab-btn" onclick="switchTab('advanced')">Advanced</button>
            <button class="tab-btn" onclick="switchTab('config')">Config</button>
            <button class="tab-btn" onclick="switchTab('random')">Random</button>
        </div>

        <!-- BASIC TAB -->
        <div id="basic-tab" class="tab-content active">
            <!-- Presets -->
            <div class="settings-group">
                <h2>üíæ Presets</h2>
                <select id="presetSelect">
                    <option value="">-- Select Preset --</option>
                </select>
                <div class="preset-grid">
                    <button onclick="applySelectedPreset()">Apply</button>
                    <button class="secondary" onclick="savePreset()">Save</button>
                </div>
            </div>

            <!-- Analyzer Mode -->
            <div class="settings-group">
                <h2>üéµ Analyzer Mode</h2>
                <form id="modeSelect">
                    <select id="mode">
                        <option value="0">Discrete frequencies</option>
                        <option value="1">Bars 1/12th octave</option>
                        <option value="2">Bars 1/8th octave</option>
                        <option value="3">Bars 1/6th octave</option>
                        <option value="4">Bars 1/4th octave</option>
                        <option value="5">Bars 1/3rd octave</option>
                        <option value="6">Bars Half octave</option>
                        <option value="7">Bars Full octave</option>
                        <option value="8">Bars Line graph</option>
                        <option value="10">Graph</option>
                    </select>
                </form>
            </div>

            <!-- Gradients -->
            <div class="settings-group">
                <h2>üé® Gradients</h2>
                <label>Left/Main Gradient</label>
                <select id="gradient"></select>

                <label style="margin-top: 12px;">Right Gradient</label>
                <select id="gradientRight"></select>

                <div class="switch-bar" style="margin-top: 12px;">
                    <div class="switch" id="linkGrads" data-active="0">LINK</div>
                    <div class="switch" id="splitGrad" data-active="0">SPLIT</div>
                </div>
            </div>

            <!-- Bar Color Mode -->
            <div class="settings-group">
                <h2>üåà Bar Color Mode</h2>
                <form id="colorModeSelect" class="custom-radio-buttons">
                    <input type="radio" name="colorMode" value="gradient" id="color-gradient" checked>
                    <label for="color-gradient">Gradient</label>
                    <input type="radio" name="colorMode" value="bar-index" id="color-index">
                    <label for="color-index">Index</label>
                    <input type="radio" name="colorMode" value="bar-level" id="color-level">
                    <label for="color-level">Level</label>
                </form>
            </div>

            <!-- Bar Adjustments -->
            <div class="settings-group">
                <h2>üìè Bar Adjustments</h2>

                <label>
                    Bar Spacing: <span class="value-display" id="barSpaceValue">0.10</span>
                </label>
                <input id="barSpace" type="range" min="0" max="1" step="0.05" value="0.1">

                <label>
                    Fill Alpha: <span class="value-display" id="fillAlphaValue">0.30</span>
                </label>
                <input id="fillAlpha" type="range" min="0" max="1" step="0.05" value="0.3">

                <label>
                    Line Width: <span class="value-display" id="lineWidthValue">0</span>
                </label>
                <input id="lineWidth" type="range" min="0" max="3" step="0.5" value="0">
            </div>

            <!-- Sensitivity -->
            <div class="settings-group">
                <h2>üéöÔ∏è Sensitivity</h2>
                <form id="sensitivitySelect" class="custom-radio-buttons">
                    <input type="radio" name="sensitivity" value="0" id="sens-low">
                    <label for="sens-low">Low</label>
                    <input type="radio" name="sensitivity" value="1" id="sens-med" checked>
                    <label for="sens-med">Medium</label>
                    <input type="radio" name="sensitivity" value="2" id="sens-high">
                    <label for="sens-high">High</label>
                </form>
            </div>

            <!-- Effects -->
            <div class="settings-group">
                <h2>‚ú® Effects</h2>
                <div class="switch-bar">
                    <div class="switch" id="alphaBars" data-active="0">Alpha</div>
                    <div class="switch" id="lumiBars" data-active="0">Lumi</div>
                    <div class="switch" id="ledBars" data-active="0">LEDs</div>
                    <div class="switch" id="outlineBars" data-active="0">Outline</div>
                    <div class="switch" id="radial" data-active="0">Radial</div>
                    <div class="switch" id="roundBars" data-active="0">Round</div>
                </div>
            </div>

            <!-- Reflex -->
            <div class="settings-group">
                <h2>üîÑ Reflex</h2>
                <form id="reflexSelect" class="custom-radio-buttons">
                    <input type="radio" name="reflex" value="0" id="reflex-off" checked>
                    <label for="reflex-off">Off</label>
                    <input type="radio" name="reflex" value="3" id="reflex-25">
                    <label for="reflex-25">25%</label>
                    <input type="radio" name="reflex" value="1" id="reflex-40">
                    <label for="reflex-40">40%</label>
                    <input type="radio" name="reflex" value="2" id="reflex-mirror">
                    <label for="reflex-mirror">Mirror</label>
                </form>
            </div>

            <!-- Scale Labels -->
            <div class="settings-group">
                <h2>üìä Scale Labels</h2>
                <label>X-Axis Labels</label>
                <form id="scaleXSelect" class="custom-radio-buttons">
                    <input type="radio" name="scaleX" value="0" id="scaleX-off">
                    <label for="scaleX-off">Off</label>
                    <input type="radio" name="scaleX" value="1" id="scaleX-freq" checked>
                    <label for="scaleX-freq">Freqs</label>
                    <input type="radio" name="scaleX" value="2" id="scaleX-notes">
                    <label for="scaleX-notes">Notes</label>
                </form>

                <label style="margin-top: 12px;">Y-Axis Labels</label>
                <form id="showScaleY" class="custom-radio-buttons">
                    <input type="radio" name="scaleY" value="false" id="scaleY-off" checked>
                    <label for="scaleY-off">Off</label>
                    <input type="radio" name="scaleY" value="true" id="scaleY-on">
                    <label for="scaleY-on">On</label>
                </form>
            </div>
        </div>

        <!-- ADVANCED TAB -->
        <div id="advanced-tab" class="tab-content">
            <!-- Channel Layout -->
            <div class="settings-group">
                <h2>üì° Channel Layout</h2>
                <select id="channelLayout">
                    <option value="single">Single</option>
                    <option value="dual-combined">Dual Combined</option>
                    <option value="dual-horizontal">Dual Horizontal</option>
                    <option value="dual-vertical">Dual Vertical</option>
                </select>
            </div>

            <!-- Mirror -->
            <div class="settings-group">
                <h2>ü™û Mirror</h2>
                <form id="mirrorSelect" class="custom-radio-buttons">
                    <input type="radio" name="mirror" value="-1" id="mirror-left">
                    <label for="mirror-left">Left</label>
                    <input type="radio" name="mirror" value="0" id="mirror-off" checked>
                    <label for="mirror-off">Off</label>
                    <input type="radio" name="mirror" value="1" id="mirror-right">
                    <label for="mirror-right">Right</label>
                </form>
            </div>

            <!-- Frequency Settings -->
            <div class="settings-group">
                <h2>üéº Frequency Settings</h2>

                <label>Frequency Scale</label>
                <form id="freqScaleSelect" class="custom-radio-buttons">
                    <input type="radio" name="freqScale" value="bark" id="scale-bark">
                    <label for="scale-bark">Bark</label>
                    <input type="radio" name="freqScale" value="linear" id="scale-linear">
                    <label for="scale-linear">Linear</label>
                    <input type="radio" name="freqScale" value="log" id="scale-log" checked>
                    <label for="scale-log">Log</label>
                    <input type="radio" name="freqScale" value="mel" id="scale-mel">
                    <label for="scale-mel">Mel</label>
                </form>

                <label style="margin-top: 12px;">
                    Frequency Range: <span class="value-display" id="freqRangeValue">20Hz - 22kHz</span>
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px;">
                    <input id="minFreq" type="number" placeholder="Min (Hz)" value="20" style="margin: 0;">
                    <input id="maxFreq" type="number" placeholder="Max (Hz)" value="22000" style="margin: 0;">
                </div>
            </div>



            <!-- Radial Settings -->
            <div class="settings-group">
                <h2>‚≠ï Radial Settings</h2>

                <label>
                    Radius: <span class="value-display" id="radiusValue">0.30</span>
                </label>
                <input id="radius" type="range" min="0" max="1" step="0.05" value="0.3">

                <label>
                    Spin Speed: <span class="value-display" id="spinSpeedValue">0 RPM</span>
                </label>
                <input id="spinSpeed" type="range" min="-10" max="10" step="1" value="0">
            </div>

            <!-- FFT Settings -->
            <div class="settings-group">
                <h2>üî¨ FFT Analysis</h2>

                <label>FFT Size</label>
                <select id="fftSize">
                    <option value="2048">2048</option>
                    <option value="4096">4096</option>
                    <option value="8192" selected>8192</option>
                    <option value="16384">16384</option>
                </select>

                <label>
                    Smoothing: <span class="value-display" id="smoothingValue">0.70</span>
                </label>
                <input id="smoothing" type="range" min="0" max="0.9" step="0.05" value="0.7">

                <label style="margin-top: 12px;">Octave Bands</label>
                <form id="ansiBandsSelect" class="custom-radio-buttons">
                    <input type="radio" name="ansiBands" value="0" id="bands-tempered" checked>
                    <label for="bands-tempered">Tempered</label>
                    <input type="radio" name="ansiBands" value="1" id="bands-ansi">
                    <label for="bands-ansi">ANSI/IEC</label>
                </form>

                <label style="margin-top: 12px;">Level Scale</label>
                <form id="linearAmplitudeSelect" class="custom-radio-buttons">
                    <input type="radio" name="linearAmplitude" value="0" id="ampl-db">
                    <label for="ampl-db">Decibels</label>
                    <input type="radio" name="linearAmplitude" value="1" id="ampl-linear" checked>
                    <label for="ampl-linear">Linear</label>
                </form>

                <label style="margin-top: 12px;">Weighting Filter</label>
                <select id="weightingFilter">
                    <option value="">Off</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="468">468</option>
                </select>
            </div>
        </div>

        <!-- CONFIGURATION TAB -->
        <div id="config-tab" class="tab-content">
            <!-- Peak Settings -->
            <div class="settings-group">
                <h2>‚õ∞Ô∏è Peak Behavior</h2>

                <label>
                    Gravity: <span class="value-display" id="gravityValue">3.80</span>
                </label>
                <input id="gravity" type="range" min="0.01" max="25" step="0.01" value="3.8">

                <label>
                    Peak Fade Time: <span class="value-display" id="peakFadeValue">750ms</span>
                </label>
                <input id="peakFade" type="range" min="0" max="5000" step="50" value="750">

                <label>
                    Peak Hold Time: <span class="value-display" id="peakHoldValue">500ms</span>
                </label>
                <input id="peakHold" type="range" min="0" max="5000" step="50" value="500">
            </div>

            <!-- Display Options -->
            <!-- <div class="settings-group">
                <h2>üëÅÔ∏è Display Options</h2>
                <div class="switch-bar">
                    <div class="switch" id="showSong" data-active="1">Track Info</div>
                    <div class="switch" id="showFPS" data-active="0">FPS</div>
                    <div class="switch" id="loRes" data-active="0">Lo-Res</div>
                </div>
            </div> -->

            <!-- General Settings -->
            <!-- <div class="settings-group">
                <h2>‚öôÔ∏è General</h2>

                <label>Max FPS</label>
                <select id="maxFPS">
                    <option value="30">30</option>
                    <option value="60" selected>60</option>
                    <option value="0">Unlimited</option>
                </select>

                <label>
                    Fullscreen Height: <span class="value-display" id="fsHeightValue">100%</span>
                </label>
                <input id="fsHeight" type="range" min="25" max="100" step="5" value="100">

                <label><input type="checkbox" id="autoHide"> Auto-hide panel on hover</label>
            </div> -->

            <!-- Background Settings -->
            <div class="settings-group">
                <h2>üñºÔ∏è Background</h2>

                <label>Background Type</label>
                <select id="bgType">
                    <option value="none">None (Gradient)</option>
                    <option value="cover">Album Cover</option>
                    <option value="file">Background File</option>
                </select>

                <label id="bgFileLabel" style="display: none;">Select File</label>
                <select id="bgFile" style="display: none;">
                    <option value="">-- Select File --</option>
                </select>

                <label>
                    Background Dim: <span class="value-display" id="bgDimValue">0.5</span>
                </label>
                <input id="bgDim" type="range" min="0" max="1" step="0.1" value="0.5">

                <label>Image Fit</label>
                <select id="bgFit">
                    <option value="cover">Cover</option>
                    <option value="contain">Contain</option>
                    <option value="fill">Fill</option>
                </select>

                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="secondary" onclick="refreshBackgroundFiles()" style="flex: 1;">üîÑ Refresh</button>
                    <button class="secondary" onclick="document.getElementById('bgUploadInput').click()" style="flex: 1;">üì§ Upload</button>
                </div>
                <input type="file" id="bgUploadInput" accept="image/*,video/*" style="display: none;" onchange="uploadBackground(this)">
                <div id="uploadStatus" style="font-size: 12px; color: #8b9dc3; margin-top: 8px; display: none;"></div>
            </div>

            <div class="settings-group">
                <h2>üëÅÔ∏è UI Visibility</h2>
                <label><input type="checkbox" id="showControlBar" checked> Show Control Bar</label>
                <label><input type="checkbox" id="showNowPlaying" checked> Show Now Playing</label>
            </div>

            <div class="settings-group">
                <h2>üéõÔ∏è Now Playing Layout</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>
                        <label>X (px)</label>
                        <input id="npX" type="number" min="0" value="16">
                    </div>
                    <div>
                        <label>Y (px)</label>
                        <input id="npY" type="number" min="0" value="16">
                    </div>
                    <div>
                        <label>Width (px)</label>
                        <input id="npW" type="number" min="320" value="600">
                    </div>
                    <div>
                        <label>Height (px)</label>
                        <input id="npH" type="text" min="100" value="auto" placeholder="auto">
                    </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="secondary" id="applyNowPlayingLayoutBtn">Apply</button>
                    <button class="secondary" id="resetNowPlayingLayoutBtn">Reset</button>
                </div>
            </div>
            <!-- Bar Adjustments -->
            <div class="settings-group">
                <h2>üìè Volume</h2>

                <label>
                    Volume: <span class="value-display" id="volumeValue">0.00</span>
                </label>
                <input id="volume" type="range" min="0" max="1" step="0.05" value="0">

            </div>
            <!-- Update Settings on Server -->
            <div class="settings-group">
                <h2>‚¨ÜÔ∏è Update setting on server</h2>
                <button id="uploadSettingsBtn" onclick="uploadSettings()">‚¨ÜÔ∏è Update setting on server</button>
            </div>
        </div>

        <!-- RANDOM TAB -->
        <div id="random-tab" class="tab-content">
            <!-- Random Options -->
            <div class="settings-group">
                <h2>üé≤ Randomize Options</h2>
                <label><input type="checkbox" id="randomMode"> Analyzer Mode</label>
                <label><input type="checkbox" id="randomGradient"> Left/Main Gradient</label>
                <label><input type="checkbox" id="randomGradientRight"> Right Gradient</label>
                <label><input type="checkbox" id="randomColorMode"> Bar Color Mode</label>
                <label><input type="checkbox" id="randomBarSpace"> Bar Spacing</label>
                <label><input type="checkbox" id="randomFillAlpha"> Fill Alpha</label>
                <label><input type="checkbox" id="randomLineWidth"> Line Width</label>
                <label><input type="checkbox" id="randomSensitivity"> Sensitivity</label>
                <label><input type="checkbox" id="randomMirror"> Mirror</label>
                <label><input type="checkbox" id="randomAlphaBars"> Alpha Bars</label>
                <label><input type="checkbox" id="randomLumiBars"> Lumi Bars</label>
                <label><input type="checkbox" id="randomLedBars"> LED Bars</label>
                <label><input type="checkbox" id="randomOutlineBars"> Outline Bars</label>
                <label><input type="checkbox" id="randomRadial"> Radial</label>
                <label><input type="checkbox" id="randomRoundBars"> Round Bars</label>
                <label><input type="checkbox" id="randomBgType"> Background Type</label>
                <label><input type="checkbox" id="randomBgFile"> Background File</label>
                <label><input type="checkbox" id="randomBgFit"> Background Fit</label>
            </div>

            <!-- Random Triggers -->
            <div class="settings-group">
                <h2>‚è±Ô∏è Random Triggers</h2>

                <label><input type="checkbox" id="randomOnTrackChange"> Randomize on track change</label>

                <label style="margin-top: 16px;">
                    <input type="checkbox" id="randomOnInterval"> Randomize every
                </label>
                <div style="display: flex; gap: 8px; align-items: center; margin-top: 6px;">
                    <input id="randomInterval" type="number" min="1" max="3600" value="30" style="flex: 1;">
                    <span style="color: #8b9dc3; font-size: 13px;">seconds</span>
                </div>
            </div>

            <!-- Random Actions -->
            <div class="settings-group">
                <h2>üéØ Actions</h2>
                <button onclick="randomizeNow()">üé≤ Randomize Now</button>
                <button class="secondary" onclick="selectAllRandom()">‚òëÔ∏è Select All</button>
                <button class="secondary" onclick="deselectAllRandom()">‚òê Deselect All</button>
            </div>

            <!-- Random Status -->
            <div class="settings-group">
                <h2>üìä Status</h2>
                <div id="randomStatus"
                    style="font-size: 12px; color: #8b9dc3; padding: 12px; background: #1a1e25; border-radius: 8px;">
                    <div>Next randomization: <span id="randomNextTime">-</span></div>
                    <div style="margin-top: 4px;">Last randomization: <span id="randomLastTime">Never</span></div>
                </div>
            </div>
        </div>
    </div>

    <script src="audiomotion-analyzer.min.js"></script>
    <script type="module" src="spectrum.js"></script>

    <!-- Random Settings Logic -->
    <script>
        (function () {
            let randomIntervalTimer = null;
            let lastRandomTime = null;
            let nextRandomTime = null;

            // Randomize now
            window.randomizeNow = function () {
                const options = {
                    mode: document.getElementById('randomMode')?.checked,
                    gradient: document.getElementById('randomGradient')?.checked,
                    gradientRight: document.getElementById('randomGradientRight')?.checked,
                    colorMode: document.getElementById('randomColorMode')?.checked,
                    barSpace: document.getElementById('randomBarSpace')?.checked,
                    fillAlpha: document.getElementById('randomFillAlpha')?.checked,
                    lineWidth: document.getElementById('randomLineWidth')?.checked,
                    sensitivity: document.getElementById('randomSensitivity')?.checked,
                    mirror: document.getElementById('randomMirror')?.checked,
                    alphaBars: document.getElementById('randomAlphaBars')?.checked,
                    lumiBars: document.getElementById('randomLumiBars')?.checked,
                    ledBars: document.getElementById('randomLedBars')?.checked,
                    outlineBars: document.getElementById('randomOutlineBars')?.checked,
                    radial: document.getElementById('randomRadial')?.checked,
                    roundBars: document.getElementById('randomRoundBars')?.checked,
                    bgType: document.getElementById('randomBgType')?.checked,
                    bgFile: document.getElementById('randomBgFile')?.checked,
                    bgFit: document.getElementById('randomBgFit')?.checked
                };

                applyRandomization(options);
                updateRandomStatus();
            };

            function applyRandomization(options) {
                // Mode
                if (options.mode) {
                    const modeSelect = document.getElementById('mode');
                    const modeOptions = Array.from(modeSelect.options);
                    const randomMode = modeOptions[Math.floor(Math.random() * modeOptions.length)];
                    modeSelect.value = randomMode.value;
                    modeSelect.dispatchEvent(new Event('change'));
                }

                // Gradient
                if (options.gradient) {
                    const gradSelect = document.getElementById('gradient');
                    const gradOptions = Array.from(gradSelect.options);
                    const randomGrad = gradOptions[Math.floor(Math.random() * gradOptions.length)];
                    gradSelect.value = randomGrad.value;
                    gradSelect.dispatchEvent(new Event('change'));
                }

                // Gradient Right
                if (options.gradientRight) {
                    const gradRightSelect = document.getElementById('gradientRight');
                    const gradRightOptions = Array.from(gradRightSelect.options);
                    const randomGradRight = gradRightOptions[Math.floor(Math.random() * gradRightOptions.length)];
                    gradRightSelect.value = randomGradRight.value;
                    gradRightSelect.dispatchEvent(new Event('change'));
                }

                // Color Mode
                if (options.colorMode) {
                    const colorModes = ['gradient', 'bar-index', 'bar-level'];
                    const randomColorMode = colorModes[Math.floor(Math.random() * colorModes.length)];
                    document.getElementById(`color-${randomColorMode}`)?.click();
                }

                // Bar Space (0 to 1)
                if (options.barSpace) {
                    const barSpaceSlider = document.getElementById('barSpace');
                    barSpaceSlider.value = (Math.random()).toFixed(2);
                    barSpaceSlider.dispatchEvent(new Event('input'));
                }

                // Fill Alpha (0 to 1)
                if (options.fillAlpha) {
                    const fillAlphaSlider = document.getElementById('fillAlpha');
                    fillAlphaSlider.value = (Math.random()).toFixed(2);
                    fillAlphaSlider.dispatchEvent(new Event('input'));
                }

                // Line Width (0 to 3)
                if (options.lineWidth) {
                    const lineWidthSlider = document.getElementById('lineWidth');
                    const randomWidth = (Math.random() * 3).toFixed(1);
                    lineWidthSlider.value = randomWidth;
                    lineWidthSlider.dispatchEvent(new Event('input'));
                }

                // Sensitivity
                if (options.sensitivity) {
                    const sensLevels = ['0', '1', '2'];
                    const randomSens = sensLevels[Math.floor(Math.random() * sensLevels.length)];
                    document.getElementById(`sens-${randomSens === '0' ? 'low' : randomSens === '1' ? 'med' : 'high'}`)?.click();
                }

                // Mirror
                if (options.mirror) {
                    const mirrorValues = ['-1', '0', '1'];
                    const randomMirror = mirrorValues[Math.floor(Math.random() * mirrorValues.length)];
                    document.getElementById(`mirror-${randomMirror === '-1' ? 'left' : randomMirror === '0' ? 'off' : 'right'}`)?.click();
                }

                // Toggle switches
                const toggles = [
                    { option: 'alphaBars', id: 'alphaBars' },
                    { option: 'lumiBars', id: 'lumiBars' },
                    { option: 'ledBars', id: 'ledBars' },
                    { option: 'outlineBars', id: 'outlineBars' },
                    { option: 'radial', id: 'radial' },
                    { option: 'roundBars', id: 'roundBars' }
                ];

                toggles.forEach(toggle => {
                    if (options[toggle.option]) {
                        const element = document.getElementById(toggle.id);
                        const randomState = Math.random() > 0.5;
                        element.setAttribute('data-active', randomState ? '1' : '0');
                        element.dispatchEvent(new Event('click'));
                    }
                });

                // Background Type
                if (options.bgType) {
                    const bgTypeSelect = document.getElementById('bgType');
                    const bgTypeOptions = Array.from(bgTypeSelect.options);
                    const randomBgType = bgTypeOptions[Math.floor(Math.random() * bgTypeOptions.length)];
                    bgTypeSelect.value = randomBgType.value;
                    bgTypeSelect.dispatchEvent(new Event('change'));
                }

                // Background File
                if (options.bgFile) {
                    const bgFileSelect = document.getElementById('bgFile');
                    const bgFileOptions = Array.from(bgFileSelect.options).filter(opt => opt.value !== '');
                    if (bgFileOptions.length > 0) {
                        const randomBgFile = bgFileOptions[Math.floor(Math.random() * bgFileOptions.length)];
                        bgFileSelect.value = randomBgFile.value;
                        bgFileSelect.dispatchEvent(new Event('change'));
                    }
                }

                // Background Fit
                if (options.bgFit) {
                    const bgFitSelect = document.getElementById('bgFit');
                    const bgFitOptions = Array.from(bgFitSelect.options);
                    const randomBgFit = bgFitOptions[Math.floor(Math.random() * bgFitOptions.length)];
                    bgFitSelect.value = randomBgFit.value;
                    bgFitSelect.dispatchEvent(new Event('change'));
                }

                lastRandomTime = new Date();
            }

            function updateRandomStatus() {
                const lastTimeEl = document.getElementById('randomLastTime');
                const nextTimeEl = document.getElementById('randomNextTime');

                if (lastRandomTime) {
                    lastTimeEl.textContent = lastRandomTime.toLocaleTimeString();
                }

                if (nextRandomTime) {
                    nextTimeEl.textContent = nextRandomTime.toLocaleTimeString();
                } else {
                    nextTimeEl.textContent = '-';
                }
            }

            function startRandomInterval() {
                stopRandomInterval();

                const intervalCheckbox = document.getElementById('randomOnInterval');
                const intervalInput = document.getElementById('randomInterval');

                if (intervalCheckbox?.checked) {
                    const seconds = parseInt(intervalInput.value || '30');
                    nextRandomTime = new Date(Date.now() + seconds * 1000);
                    updateRandomStatus();

                    randomIntervalTimer = setInterval(() => {
                        randomizeNow();
                        nextRandomTime = new Date(Date.now() + seconds * 1000);
                        updateRandomStatus();
                    }, seconds * 1000);
                }
            }

            function stopRandomInterval() {
                if (randomIntervalTimer) {
                    clearInterval(randomIntervalTimer);
                    randomIntervalTimer = null;
                    nextRandomTime = null;
                    updateRandomStatus();
                }
            }

            // Select/Deselect all
            window.selectAllRandom = function () {
                document.querySelectorAll('#random-tab input[type="checkbox"]').forEach(cb => {
                    if (!cb.id.startsWith('randomOn')) {
                        cb.checked = true;
                    }
                });
            };

            window.deselectAllRandom = function () {
                document.querySelectorAll('#random-tab input[type="checkbox"]').forEach(cb => {
                    if (!cb.id.startsWith('randomOn')) {
                        cb.checked = false;
                    }
                });
            };

            // Setup event listeners
            document.getElementById('randomOnInterval')?.addEventListener('change', function () {
                if (this.checked) {
                    startRandomInterval();
                } else {
                    stopRandomInterval();
                }
            });

            document.getElementById('randomInterval')?.addEventListener('change', function () {
                if (document.getElementById('randomOnInterval')?.checked) {
                    startRandomInterval();
                }
            });

            // Hook into track change (you'll need to call this from your main spectrum.js)
            window.onTrackChange = function () {
                if (document.getElementById('randomOnTrackChange')?.checked) {
                    randomizeNow();
                }
            };

            // Update status every second
            setInterval(updateRandomStatus, 1000);
        })();
    </script>

    <!-- Now Playing Drag & Visibility Management -->
    <script>
        (function () {
            const box = document.getElementById("nowPlaying");
            if (!box) return;

            // Drag functionality
            let dragging = false;
            let pos = { x: 0, y: 0 };
            let mouse = { x: 0, y: 0 };

            function onMouseDown(e) {
                if (e.target.closest(".control-btn") || e.target.classList.contains('resize-handle')) return;
                dragging = true;
                box.classList.add("dragging");
                mouse.x = e.clientX;
                mouse.y = e.clientY;
                const rect = box.getBoundingClientRect();
                pos.x = rect.left;
                pos.y = rect.top;
                e.preventDefault();
            }

            function onMouseMove(e) {
                if (!dragging) return;
                const dx = e.clientX - mouse.x;
                const dy = e.clientY - mouse.y;
                box.style.left = pos.x + dx + "px";
                box.style.top = pos.y + dy + "px";
                box.style.right = "auto";
                box.style.bottom = "auto";
                // update inputs
                const npX = document.getElementById('npX');
                const npY = document.getElementById('npY');
                if (npX) npX.value = Math.round(pos.x + dx);
                if (npY) npY.value = Math.round(pos.y + dy);
            }

            function onMouseUp() {
                if (!dragging) return;
                dragging = false;
                box.classList.remove("dragging");
            }

            box.addEventListener("mousedown", onMouseDown);
            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);

            // Visibility control: respect showNowPlaying checkbox
            const showCheckbox = document.getElementById('showNowPlaying');
            if (showCheckbox) {
                showCheckbox.addEventListener('change', () => {
                    if (showCheckbox.checked) {
                        box.classList.remove('hidden-by-css');
                    } else {
                        box.classList.add('hidden-by-css');
                    }
                });
            }

            // Resize functionality
            let resizing = false;
            let resizeStart = { x: 0, y: 0, w: 0, h: 0, left: 0, top: 0 };
            let resizeMode = null; // tl, tr, bl, br

            function onResizeDown(e) {
                const handle = e.target;
                if (!handle.classList.contains('resize-handle')) return;
                resizing = true;
                resizeMode = handle.classList.contains('resize-tl') ? 'tl'
                    : handle.classList.contains('resize-tr') ? 'tr'
                        : handle.classList.contains('resize-bl') ? 'bl' : 'br';
                const rect = box.getBoundingClientRect();
                resizeStart = { x: e.clientX, y: e.clientY, w: rect.width, h: rect.height, left: rect.left, top: rect.top };
                e.preventDefault();
                e.stopPropagation();
            }

            function onResizeMove(e) {
                if (!resizing) return;
                const dx = e.clientX - resizeStart.x;
                const dy = e.clientY - resizeStart.y;
                let newW = resizeStart.w;
                let newH = resizeStart.h;
                let newLeft = resizeStart.left;
                let newTop = resizeStart.top;

                if (resizeMode === 'br') { newW += dx; newH += dy; }
                else if (resizeMode === 'bl') { newW -= dx; newH += dy; newLeft += dx; }
                else if (resizeMode === 'tr') { newW += dx; newH -= dy; newTop += dy; }
                else if (resizeMode === 'tl') { newW -= dx; newH -= dy; newLeft += dx; newTop += dy; }

                // constraints
                newW = Math.max(320, Math.min(newW, window.innerWidth - 32));
                newH = Math.max(100, Math.min(newH, window.innerHeight - 32));
                newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - newW));
                newTop = Math.max(0, Math.min(newTop, window.innerHeight - newH));

                box.style.width = newW + 'px';
                box.style.height = newH + 'px';
                box.style.left = newLeft + 'px';
                box.style.top = newTop + 'px';
                box.style.right = 'auto';
                box.style.bottom = 'auto';

                const npX = document.getElementById('npX');
                const npY = document.getElementById('npY');
                const npW = document.getElementById('npW');
                const npH = document.getElementById('npH');
                if (npX) npX.value = Math.round(newLeft);
                if (npY) npY.value = Math.round(newTop);
                if (npW) npW.value = Math.round(newW);
                if (npH) npH.value = Math.round(newH);
            }

            function onResizeUp() {
                if (!resizing) return;
                resizing = false;
            }

            box.addEventListener('mousedown', onResizeDown);
            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('mouseup', onResizeUp);

            // Apply/reset from settings inputs
            const applyBtn = document.getElementById('applyNowPlayingLayoutBtn');
            const resetBtn = document.getElementById('resetNowPlayingLayoutBtn');
            function applyFromInputs() {
                const npX = document.getElementById('npX');
                const npY = document.getElementById('npY');
                const npW = document.getElementById('npW');
                const npH = document.getElementById('npH');
                if (!npX || !npY || !npW || !npH) return;
                const x = parseInt(npX.value || '16');
                const y = parseInt(npY.value || '16');
                const w = parseInt(npW.value || '600');
                const hVal = npH.value;
                box.style.left = x + 'px';
                box.style.top = y + 'px';
                box.style.width = w + 'px';
                if (hVal && hVal !== 'auto') {
                    const h = parseInt(hVal);
                    box.style.height = h + 'px';
                } else {
                    box.style.height = '';
                }
                box.style.right = 'auto';
                box.style.bottom = 'auto';
            }
            if (applyBtn) applyBtn.addEventListener('click', applyFromInputs);
            if (resetBtn) resetBtn.addEventListener('click', () => {
                document.getElementById('npX').value = 16;
                document.getElementById('npY').value = 16;
                document.getElementById('npW').value = 600;
                document.getElementById('npH').value = 'auto';
                applyFromInputs();
            });
        })();

        // Background File visibility toggle
        (function () {
            const bgTypeSelect = document.getElementById('bgType');
            const bgFileLabel = document.getElementById('bgFileLabel');
            const bgFileSelect = document.getElementById('bgFile');

            function updateFileVisibility() {
                const isFileSelected = bgTypeSelect.value === 'file';
                bgFileLabel.style.display = isFileSelected ? 'block' : 'none';
                bgFileSelect.style.display = isFileSelected ? 'block' : 'none';
            }

            bgTypeSelect.addEventListener('change', updateFileVisibility);
            updateFileVisibility();
        })();

    </script>

</body>

</html>
