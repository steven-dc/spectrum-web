<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Volumio Spectrum Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Control Bar -->
    <div id="controlBar">
        <div id="fpsCounter" class="control-item">FPS: -- | Packets: 0</div>
        <div id="status" class="control-item connecting">‚óè Connecting</div>
        <div id="toggleSettings" class="control-item" onclick="toggleSettings()">‚öôÔ∏è</div>
    </div>

    <!-- Canvas Container -->
    <div id="canvasContainer">
        <div id="backgroundLayer"></div>
    </div>

    <!-- Now Playing -->
    <div id="nowPlaying" class="hidden">
        <div class="resize-handle resize-tl"></div>
        <div class="resize-handle resize-tr"></div>
        <div class="resize-handle resize-bl"></div>
        <div class="resize-handle resize-br"></div>
        <div class="player-container">
            <div class="track-art">
                <img id="trackArt" src="" alt="">
            </div>
            <div class="track-details">
                <div class="track-title" id="trackTitle">No track playing</div>
                <div class="track-artist" id="trackArtist">Unknown Artist</div>
                <div class="track-album" id="trackAlbum">Unknown Album</div>
                <div class="track-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
            </div>
            <div class="player-controls">
                <div class="control-btn" onclick="volumioPrevious()" title="Previous">‚Æú</div>
                <div class="control-btn play" id="playPauseBtn" onclick="volumioTogglePlay()" title="Play/Pause">‚ñ∂</div>
                <div class="control-btn" onclick="volumioNext()" title="Next">‚Æû</div>
                <div class="control-btn" onclick="toggleQueue()" title="Queue">‚ò∞</div>
                <div class="control-btn" onclick="openVolumioMusic()" title="Browse Music">üéµ</div>
            </div>
        </div>
    </div>

    <!-- Click Prompt -->
    <!-- <div id="clickPrompt" class="hidden">
        <h3>üéß Audio Ready</h3>
        <p>Click to start audio playback and visualization</p>
        <button id="startAudioBtn">Start Audio</button>
    </div> -->

    <div id="queuePanel">
        <div class="panel-header">
            <div class="panel-title">üéµ Play Queue</div>
            <div class="close-btn" onclick="toggleQueue()">√ó</div>
        </div>
        <div id="queueList"></div>
    </div>

    <div id="browsePanel">
        <div class="panel-header">
            <div class="panel-title" id="browseTitle">üé∂ Music Library</div>
            <div class="close-btn" onclick="toggleBrowse()">√ó</div>
        </div>
        <div id="browsePath"
            style="padding: 8px 12px; background: #1a1e25; font-size: 12px; color: #8b9dc3; border-bottom: 1px solid #2a2e35;">
        </div>
        <div id="browseList"></div>
    </div>
    <!-- Settings Panel -->
    <div id="settingsPanel">
        <div class="panel-header">
            <div class="panel-title">‚öôÔ∏è Settings</div>
            <div class="close-btn" onclick="toggleSettings()">√ó</div>
        </div>

        <div class="settings-tabs">
            <button class="tab-btn active" onclick="switchTab('basic')">Basic</button>
            <button class="tab-btn" onclick="switchTab('advanced')">Advanced</button>
            <button class="tab-btn" onclick="switchTab('config')">Config</button>
            <button class="tab-btn" onclick="switchTab('random')">Random</button>
        </div>

        <!-- BASIC TAB -->
        <div id="basic-tab" class="tab-content active">
            <!-- Presets -->
            <div class="settings-group">
                <h2>üíæ Presets</h2>
                <select id="presetSelect">
                    <option value="">-- Select Preset --</option>
                </select>
                <div class="preset-grid">
                    <button onclick="applySelectedPreset()">Apply</button>
                    <button class="secondary" onclick="savePreset()">Save</button>
                </div>
            </div>

            <!-- Analyzer Mode -->
            <div class="settings-group">
                <h2>üéµ Analyzer Mode</h2>
                <form id="modeSelect">
                    <select id="mode">
                        <option value="0">Discrete frequencies</option>
                        <option value="1">Bars 1/12th octave</option>
                        <option value="2">Bars 1/8th octave</option>
                        <option value="3">Bars 1/6th octave</option>
                        <option value="4">Bars 1/4th octave</option>
                        <option value="5">Bars 1/3rd octave</option>
                        <option value="6">Bars Half octave</option>
                        <option value="7">Bars Full octave</option>
                        <option value="8">Bars Line graph</option>
                        <option value="10">Graph</option>
                    </select>
                </form>
            </div>

            <!-- Gradients -->
            <div class="settings-group">
                <h2>üé® Gradients</h2>
                <label>Left/Main Gradient</label>
                <select id="gradient"></select>

                <label style="margin-top: 12px;">Right Gradient</label>
                <select id="gradientRight"></select>

                <div class="switch-bar" style="margin-top: 12px;">
                    <div class="switch" id="linkGrads" data-active="0">LINK</div>
                    <div class="switch" id="splitGrad" data-active="0">SPLIT</div>
                </div>
            </div>

            <!-- Bar Color Mode -->
            <div class="settings-group">
                <h2>üåà Bar Color Mode</h2>
                <form id="colorModeSelect" class="custom-radio-buttons">
                    <input type="radio" name="colorMode" value="gradient" id="color-gradient" checked>
                    <label for="color-gradient">Gradient</label>
                    <input type="radio" name="colorMode" value="bar-index" id="color-index">
                    <label for="color-index">Index</label>
                    <input type="radio" name="colorMode" value="bar-level" id="color-level">
                    <label for="color-level">Level</label>
                </form>
            </div>

            <!-- Bar Adjustments -->
            <div class="settings-group">
                <h2>üìè Bar Adjustments</h2>

                <label>
                    Bar Spacing: <span class="value-display" id="barSpaceValue">0.10</span>
                </label>
                <input id="barSpace" type="range" min="0" max="1" step="0.05" value="0.1">

                <label>
                    Fill Alpha: <span class="value-display" id="fillAlphaValue">0.30</span>
                </label>
                <input id="fillAlpha" type="range" min="0" max="1" step="0.05" value="0.3">

                <label>
                    Line Width: <span class="value-display" id="lineWidthValue">0</span>
                </label>
                <input id="lineWidth" type="range" min="0" max="3" step="0.5" value="0">
            </div>


            <!-- Sensitivity -->
            <div class="settings-group">
                <h2>üéöÔ∏è Sensitivity</h2>
                <form id="sensitivitySelect" class="custom-radio-buttons">
                    <input type="radio" name="sensitivity" value="0" id="sens-low">
                    <label for="sens-low">Low</label>
                    <input type="radio" name="sensitivity" value="1" id="sens-med" checked>
                    <label for="sens-med">Medium</label>
                    <input type="radio" name="sensitivity" value="2" id="sens-high">
                    <label for="sens-high">High</label>
                </form>
            </div>

            <!-- Effects -->
            <div class="settings-group">
                <h2>‚ú® Effects</h2>
                <div class="switch-bar">
                    <div class="switch" id="alphaBars" data-active="0">Alpha</div>
                    <div class="switch" id="lumiBars" data-active="0">Lumi</div>
                    <div class="switch" id="ledBars" data-active="0">LEDs</div>
                    <div class="switch" id="outlineBars" data-active="0">Outline</div>
                    <div class="switch" id="radial" data-active="0">Radial</div>
                    <div class="switch" id="roundBars" data-active="0">Round</div>
                </div>
            </div>

            <!-- Radial Settings -->
            <div class="settings-group">
                <h2>‚≠ï Radial Settings</h2>

                <label>
                    Radius: <span class="value-display" id="radiusValue">0.30</span>
                </label>
                <input id="radius" type="range" min="0" max="1" step="0.05" value="0.3">

                <label>
                    Spin Speed: <span class="value-display" id="spinSpeedValue">0 RPM</span>
                </label>
                <input id="spinSpeed" type="range" min="-10" max="10" step="1" value="0">
            </div>
            <!-- Reflex -->
            <div class="settings-group">
                <h2>üîÑ Reflex</h2>
                <form id="reflexSelect" class="custom-radio-buttons">
                    <input type="radio" name="reflex" value="0" id="reflex-off" checked>
                    <label for="reflex-off">Off</label>
                    <input type="radio" name="reflex" value="3" id="reflex-25">
                    <label for="reflex-25">25%</label>
                    <input type="radio" name="reflex" value="1" id="reflex-40">
                    <label for="reflex-40">40%</label>
                    <input type="radio" name="reflex" value="2" id="reflex-mirror">
                    <label for="reflex-mirror">Mirror</label>
                </form>
            </div>

            <!-- Scale Labels -->
            <div class="settings-group">
                <h2>üìä Scale Labels</h2>
                <label>X-Axis Labels</label>
                <form id="scaleXSelect" class="custom-radio-buttons">
                    <input type="radio" name="scaleX" value="0" id="scaleX-off">
                    <label for="scaleX-off">Off</label>
                    <input type="radio" name="scaleX" value="1" id="scaleX-freq" checked>
                    <label for="scaleX-freq">Freqs</label>
                    <input type="radio" name="scaleX" value="2" id="scaleX-notes">
                    <label for="scaleX-notes">Notes</label>
                </form>

                <label style="margin-top: 12px;">Y-Axis Labels</label>
                <form id="showScaleY" class="custom-radio-buttons">
                    <input type="radio" name="scaleY" value="false" id="scaleY-off" checked>
                    <label for="scaleY-off">Off</label>
                    <input type="radio" name="scaleY" value="true" id="scaleY-on">
                    <label for="scaleY-on">On</label>
                </form>
            </div>
        </div>

        <!-- ADVANCED TAB -->
        <div id="advanced-tab" class="tab-content">
            <!-- Channel Layout -->
            <div class="settings-group">
                <h2>üì° Channel Layout</h2>
                <select id="channelLayout">
                    <option value="single">Single</option>
                    <option value="dual-combined">Dual Combined</option>
                    <option value="dual-horizontal">Dual Horizontal</option>
                    <option value="dual-vertical">Dual Vertical</option>
                </select>
            </div>

            <!-- Mirror -->
            <div class="settings-group">
                <h2>ü™û Mirror</h2>
                <form id="mirrorSelect" class="custom-radio-buttons">
                    <input type="radio" name="mirror" value="-1" id="mirror-left">
                    <label for="mirror-left">Left</label>
                    <input type="radio" name="mirror" value="0" id="mirror-off" checked>
                    <label for="mirror-off">Off</label>
                    <input type="radio" name="mirror" value="1" id="mirror-right">
                    <label for="mirror-right">Right</label>
                </form>
            </div>

            <!-- Frequency Settings -->
            <div class="settings-group">
                <h2>üéº Frequency Settings</h2>

                <label>Frequency Scale</label>
                <form id="freqScaleSelect" class="custom-radio-buttons">
                    <input type="radio" name="freqScale" value="bark" id="scale-bark">
                    <label for="scale-bark">Bark</label>
                    <input type="radio" name="freqScale" value="linear" id="scale-linear">
                    <label for="scale-linear">Linear</label>
                    <input type="radio" name="freqScale" value="log" id="scale-log" checked>
                    <label for="scale-log">Log</label>
                    <input type="radio" name="freqScale" value="mel" id="scale-mel">
                    <label for="scale-mel">Mel</label>
                </form>

                <label style="margin-top: 12px;">
                    Frequency Range: <span class="value-display" id="freqRangeValue">20Hz - 22kHz</span>
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px;">
                    <input id="minFreq" type="number" placeholder="Min (Hz)" value="20" style="margin: 0;">
                    <input id="maxFreq" type="number" placeholder="Max (Hz)" value="22000" style="margin: 0;">
                </div>
            </div>

            <!-- FFT Settings -->
            <div class="settings-group">
                <h2>üî¨ FFT Analysis</h2>

                <label>FFT Size</label>
                <select id="fftSize">
                    <option value="2048">2048</option>
                    <option value="4096">4096</option>
                    <option value="8192" selected>8192</option>
                    <option value="16384">16384</option>
                </select>

                <label>
                    Smoothing: <span class="value-display" id="smoothingValue">0.70</span>
                </label>
                <input id="smoothing" type="range" min="0" max="0.9" step="0.05" value="0.7">

                <label style="margin-top: 12px;">Octave Bands</label>
                <form id="ansiBandsSelect" class="custom-radio-buttons">
                    <input type="radio" name="ansiBands" value="0" id="bands-tempered" checked>
                    <label for="bands-tempered">Tempered</label>
                    <input type="radio" name="ansiBands" value="1" id="bands-ansi">
                    <label for="bands-ansi">ANSI/IEC</label>
                </form>

                <label style="margin-top: 12px;">Level Scale</label>
                <form id="linearAmplitudeSelect" class="custom-radio-buttons">
                    <input type="radio" name="linearAmplitude" value="0" id="ampl-db">
                    <label for="ampl-db">Decibels</label>
                    <input type="radio" name="linearAmplitude" value="1" id="ampl-linear" checked>
                    <label for="ampl-linear">Linear</label>
                </form>

                <label style="margin-top: 12px;">Weighting Filter</label>
                <select id="weightingFilter">
                    <option value="">Off</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="468">468</option>
                </select>
            </div>
        </div>

        <!-- CONFIGURATION TAB -->
        <div id="config-tab" class="tab-content">
            <!-- Peak Settings -->
            <div class="settings-group">
                <h2>‚õ∞Ô∏è Peak Behavior</h2>

                <label>
                    Gravity: <span class="value-display" id="gravityValue">3.80</span>
                </label>
                <input id="gravity" type="range" min="0.01" max="25" step="0.01" value="3.8">

                <label>
                    Peak Fade Time: <span class="value-display" id="peakFadeValue">750ms</span>
                </label>
                <input id="peakFade" type="range" min="0" max="5000" step="50" value="750">

                <label>
                    Peak Hold Time: <span class="value-display" id="peakHoldValue">500ms</span>
                </label>
                <input id="peakHold" type="range" min="0" max="5000" step="50" value="500">
            </div>

            <!-- Display Options -->
            <div class="settings-group">
                <h2>üëÅÔ∏è Display Options</h2>
                <div class="switch-bar">
                    <div class="switch" id="showFPS" data-active="0">FPS</div>
                    <div class="switch" id="loRes" data-active="0">Lo-Res</div>
                </div>
            </div>

            <!-- General Settings -->
            <!-- <div class="settings-group">
                <h2>‚öôÔ∏è General</h2>

                <label>Max FPS</label>
                <select id="maxFPS">
                    <option value="30">30</option>
                    <option value="60" selected>60</option>
                    <option value="0">Unlimited</option>
                </select>

                <label>
                    Fullscreen Height: <span class="value-display" id="fsHeightValue">100%</span>
                </label>
                <input id="fsHeight" type="range" min="25" max="100" step="5" value="100">

                <label><input type="checkbox" id="autoHide"> Auto-hide panel on hover</label>
            </div> -->

            <!-- Audio Source Settings -->
            <!-- <div class="settings-group">
                <h2>üéß Audio Source</h2>
                
                <label>Audio Input Source</label>
                <select id="audioSource">
                    <option value="websocket">WebSocket (Default)</option>
                    <option value="mpd">MPD HTTP Stream</option>
                </select>

                <label id="mpdUrlLabel" style="display: none; margin-top: 12px;">MPD HTTP URL</label>
                <input id="mpdUrl" type="text" placeholder="http://192.168.1.63:8001" value="http://192.168.1.63:8001" style="display: none;">

                <div style="margin-top: 12px;">
                    <button id="applyAudioSourceBtn" class="secondary">Apply Audio Source</button>
                </div>
                
                <div id="audioSourceStatus" style="font-size: 12px; color: #8b9dc3; margin-top: 8px; display: none;"></div>
            </div> -->

            <!-- Background Settings -->
            <div class="settings-group">
                <h2>üñºÔ∏è Background</h2>

                <label>Background Type</label>
                <select id="bgType">
                    <option value="none">None (Gradient)</option>
                    <option value="cover">Album Cover</option>
                    <option value="file">Background File</option>
                </select>

                <label id="bgFileLabel" style="display: none;">Select File</label>
                <select id="bgFile" style="display: none;">
                    <option value="">-- Select File --</option>
                </select>

                <label>
                    Background Dim: <span class="value-display" id="bgDimValue">0.5</span>
                </label>
                <input id="bgDim" type="range" min="0" max="1" step="0.1" value="0.5">

                <label>Image Fit</label>
                <select id="bgFit">
                    <option value="cover">Cover</option>
                    <option value="contain">Contain</option>
                    <option value="fill">Fill</option>
                </select>

                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="secondary" onclick="refreshBackgroundFiles()" style="flex: 1;">üîÑ Refresh</button>
                    <button class="secondary" onclick="document.getElementById('bgUploadInput').click()"
                        style="flex: 1;">üì§ Upload</button>
                </div>
                <input type="file" id="bgUploadInput" accept="image/*,video/*" style="display: none;"
                    onchange="uploadBackground(this)">
                <div id="uploadStatus" style="font-size: 12px; color: #8b9dc3; margin-top: 8px; display: none;"></div>
            </div>

            <!-- Audio Source Settings -->
            <div class="settings-group">
                <h2>üéß Audio Source</h2>

                <label>Audio Input Source</label>
                <select id="audioSource">
                    <option value="websocket">WebSocket (Default)</option>
                    <option value="mpd">MPD HTTP Stream</option>
                </select>

                <label id="mpdUrlLabel" style="display: none; margin-top: 12px;">MPD HTTP URL</label>
                <input id="mpdUrl" type="text" placeholder="http://192.168.1.63:8001" value="http://192.168.1.63:8001"
                    style="display: none;">

                <div style="margin-top: 12px;">
                    <button id="applyAudioSourceBtn" class="secondary">Apply Audio Source</button>
                </div>

                <div id="audioSourceStatus" style="font-size: 12px; color: #8b9dc3; margin-top: 8px; display: none;">
                </div>
            </div>

            <div class="settings-group">
                <h2>üëÅÔ∏è UI Visibility</h2>
                <label><input type="checkbox" id="showControlBar" checked> Show Control Bar</label>
                <label><input type="checkbox" id="showNowPlaying" checked> Show Now Playing</label>
            </div>

            <div class="settings-group">
                <h2>üéõÔ∏è Now Playing Layout</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>
                        <label>X (px)</label>
                        <input id="npX" type="number" min="0" value="16">
                    </div>
                    <div>
                        <label>Y (px)</label>
                        <input id="npY" type="number" min="0" value="16">
                    </div>
                    <div>
                        <label>Width (px)</label>
                        <input id="npW" type="number" min="320" value="600">
                    </div>
                    <div>
                        <label>Height (px)</label>
                        <input id="npH" type="text" min="100" value="auto" placeholder="auto">
                    </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:12px;">
                    <button class="secondary" id="applyNowPlayingLayoutBtn">Apply</button>
                    <button class="secondary" id="resetNowPlayingLayoutBtn">Reset</button>
                </div>
            </div>
            <!-- Bar Adjustments -->
            <div class="settings-group">
                <h2>üìè Volume</h2>

                <label>
                    Volume: <span class="value-display" id="volumeValue">0.00</span>
                </label>
                <input id="volume" type="range" min="0" max="1" step="0.05" value="0">

            </div>
            <!-- Update Settings on Server -->
            <div class="settings-group">
                <h2>‚¨ÜÔ∏è Update setting on server</h2>
                <button id="uploadSettingsBtn" onclick="uploadSettings()">‚¨ÜÔ∏è Update setting on server</button>
            </div>
        </div>

        <!-- RANDOM TAB -->
        <div id="random-tab" class="tab-content">
            <!-- Random Options -->
            <div class="settings-group">
                <h2>üé≤ Randomize Options</h2>
                <label><input type="checkbox" id="randomMode"> Analyzer Mode</label>
                <label><input type="checkbox" id="randomGradient"> Left/Main Gradient</label>
                <label><input type="checkbox" id="randomGradientRight"> Right Gradient</label>
                <label><input type="checkbox" id="randomColorMode"> Bar Color Mode</label>
                <label><input type="checkbox" id="randomBarSpace"> Bar Spacing</label>
                <label><input type="checkbox" id="randomFillAlpha"> Fill Alpha</label>
                <label><input type="checkbox" id="randomLineWidth"> Line Width</label>
                <label><input type="checkbox" id="randomSensitivity"> Sensitivity</label>
                <label><input type="checkbox" id="randomMirror"> Mirror</label>
                <label><input type="checkbox" id="randomAlphaBars"> Alpha Bars</label>
                <label><input type="checkbox" id="randomLumiBars"> Lumi Bars</label>
                <label><input type="checkbox" id="randomLedBars"> LED Bars</label>
                <label><input type="checkbox" id="randomOutlineBars"> Outline Bars</label>
                <label><input type="checkbox" id="randomRadial"> Radial</label>
                <label><input type="checkbox" id="randomRoundBars"> Round Bars</label>
                <label><input type="checkbox" id="randomBgType"> Background Type</label>
                <label><input type="checkbox" id="randomBgFile"> Background File</label>
                <label><input type="checkbox" id="randomBgFit"> Background Fit</label>
            </div>

            <!-- Random Triggers -->
            <div class="settings-group">
                <h2>‚è±Ô∏è Random Triggers</h2>

                <label><input type="checkbox" id="randomOnTrackChange"> Randomize on track change</label>

                <label style="margin-top: 16px;">
                    <input type="checkbox" id="randomOnInterval"> Randomize every
                </label>
                <div style="display: flex; gap: 8px; align-items: center; margin-top: 6px;">
                    <input id="randomInterval" type="number" min="1" max="3600" value="30" style="flex: 1;">
                    <span style="color: #8b9dc3; font-size: 13px;">seconds</span>
                </div>
            </div>

            <!-- Random Actions -->
            <div class="settings-group">
                <h2>üéØ Actions</h2>
                <button onclick="randomizeNow()">üé≤ Randomize Now</button>
                <button class="secondary" onclick="selectAllRandom()">‚òëÔ∏è Select All</button>
                <button class="secondary" onclick="deselectAllRandom()">‚òê Deselect All</button>
            </div>

            <!-- Random Status -->
            <div class="settings-group">
                <h2>üìä Status</h2>
                <div id="randomStatus"
                    style="font-size: 12px; color: #8b9dc3; padding: 12px; background: #1a1e25; border-radius: 8px;">
                    <div>Next randomization: <span id="randomNextTime">-</span></div>
                    <div style="margin-top: 4px;">Last randomization: <span id="randomLastTime">Never</span></div>
                </div>
            </div>
        </div>
    </div>

    <script src="audiomotion-analyzer.min.js"></script>
    <!-- Socket.IO client for Volumio push updates (fallback to polling if unavailable) -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="spectrum.js"></script>
    <script src="presets.js"></script>
</body>

</html>